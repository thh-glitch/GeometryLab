<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¾ä½•ç¸ç·¨å¹´å² v5.0 - å¹¾ä½•èµ·æº</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --console-body: #4a4a4a;
            --screen-bg: #2d3e30; /* æ·±ç¶ è‰² CRT é¢¨æ ¼ */
            --pixel-color: #98fb98; /* è¢å…‰ç¶ æ–‡å­— */
            --highlight: #00ff00;
            --danger: #ff4444;
            --accent: #55ffff;
        }

        body {
            background-color: var(--bg-color);
            color: var(--pixel-color);
            font-family: 'Press Start 2P', cursive;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            user-select: none;
            overflow: hidden;
        }

        #game-console {
            background: linear-gradient(180deg, #555 0%, #333 100%);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.6);
            border: 4px solid #111;
            width: 400px;
            position: relative;
        }

        #screen-border {
            background: #111;
            padding: 15px;
            border-radius: 15px;
            box-shadow: inset 0 0 10px #000;
        }

        #screen {
            background-color: var(--screen-bg);
            width: 100%;
            height: 450px;
            position: relative;
            border: 2px solid #555;
            overflow: hidden;
            image-rendering: pixelated;
        }

        /* å¾©å¤æƒæç·š */
        #screen::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }

        /* UI å±¤ */
        .hud {
            position: absolute;
            top: 10px; left: 10px; right: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            z-index: 15;
            text-shadow: 1px 1px 0 #000;
        }

        /* ç¶“é©—æ¢ */
        .exp-bar-frame {
            position: absolute;
            top: 25px; left: 10px; right: 10px;
            height: 6px;
            background: #111;
            border: 1px solid #555;
            z-index: 15;
        }
        .exp-bar-fill {
            height: 100%;
            width: 0%;
            background: var(--highlight);
            transition: width 0.5s;
            box-shadow: 0 0 5px var(--highlight);
        }

        canvas { position: absolute; top: 0; left: 0; z-index: 5; }

        /* åº•éƒ¨æ“ä½œå€ */
        #command-center {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            height: 140px;
            background: rgba(0, 20, 0, 0.95);
            border-top: 2px solid var(--pixel-color);
            padding: 15px;
            box-sizing: border-box;
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        #msg-box {
            font-size: 10px;
            line-height: 1.6;
            color: #ccffcc;
            min-height: 40px;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            justify-content: space-between;
        }

        input {
            background: #000;
            border: 1px solid var(--pixel-color);
            color: var(--highlight);
            font-family: inherit;
            padding: 8px;
            width: 60px;
            text-align: center;
        }

        button {
            background: #222;
            color: var(--pixel-color);
            border: 1px solid var(--pixel-color);
            padding: 8px 12px;
            font-family: inherit;
            font-size: 10px;
            cursor: pointer;
            text-transform: uppercase;
        }
        button:hover { background: #333; box-shadow: 0 0 5px var(--pixel-color); }
        button:active { transform: translateY(2px); }

        #hint-btn { color: #ffe600; border-color: #ffe600; }
        #hint-btn:disabled { color: #555; border-color: #555; cursor: not-allowed; }

        /* é€²åŒ–é¸æ“‡ä»‹é¢ (å¡ç‰Œé¢¨æ ¼) */
        #evo-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92);
            z-index: 50;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .cards-container {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .evo-card {
            width: 90px;
            height: 140px;
            border: 2px solid #fff;
            padding: 10px;
            background: #222;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: 0.3s;
        }
        .evo-card:hover { transform: scale(1.1); box-shadow: 0 0 15px #fff; }

        .card-red { border-color: #ff5555; color: #ffcccc; }
        .card-red:hover { box-shadow: 0 0 15px #ff5555; }
        
        .card-blue { border-color: #5555ff; color: #ccccff; }
        .card-blue:hover { box-shadow: 0 0 15px #5555ff; }

        .card-yellow { border-color: #ffff55; color: #ffffcc; }
        .card-yellow:hover { box-shadow: 0 0 15px #ffff55; }

        .card-title { font-size: 9px; margin-bottom: 5px; font-weight: bold; }
        .card-desc { font-size: 7px; line-height: 1.4; color: #aaa; margin-top: auto; }
        .card-icon { font-size: 20px; margin: 10px 0; }

        /* éœ‡å‹•å‹•ç•« */
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body>

<div id="game-console">
    <div id="screen-border">
        <div id="screen">
            <div class="hud">
                <span>LV.<span id="lvl-num">1</span></span>
                <span id="monster-name">åŸç”Ÿè³ªå¹¾ä½•é«”</span>
            </div>
            <div class="exp-bar-frame"><div class="exp-bar-fill" id="exp-fill"></div></div>

            <canvas id="game-canvas" width="370" height="450"></canvas>

            <div id="evo-overlay">
                <h3 style="color:#fff; text-shadow:0 0 10px #fff;">ğŸ§¬ åŸºå› çªè®Š ğŸ§¬</h3>
                <div class="cards-container" id="cards-box">
                    </div>
            </div>

            <div id="command-center">
                <div id="msg-box">ç³»çµ±é€£ç·šä¸­...</div>
                
                <div class="controls" id="input-area">
                    <button id="hint-btn" onclick="useHint()">ğŸ’¡ æç¤º(3)</button>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span>x=</span>
                        <input type="number" id="answer-input" placeholder="?">
                    </div>
                    <button onclick="checkAnswer()" style="background:#004400; border-color:#00ff00;">æ³¨å…¥</button>
                </div>
                
                <div class="controls" id="mc-area" style="display:none; justify-content:center;">
                    <button class="mc-btn" onclick="checkMC(0)" id="btn-0" style="width:30%">A</button>
                    <button class="mc-btn" onclick="checkMC(1)" id="btn-1" style="width:30%">B</button>
                    <button class="mc-btn" onclick="checkMC(2)" id="btn-2" style="width:30%">C</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- éŠæˆ²ç‹€æ…‹ ---
    const state = {
        level: 1,
        exp: 0,
        maxExp: 3,
        hints: 3,
        question: null,
        wrongCount: 0,
        paused: false,
        // å¹¾ä½•ç¸åŸºå› åº«
        parts: {
            color: '#98fb98', // é è¨­è¢å…‰ç¶ 
            aura: 'none',     // å…‰ç’°
            horns: 'none',    // è§’
            wings: 'none',    // ç¿¼
            core: 'none'      // èƒ¸å£æ ¸å¿ƒ
        },
        name: "åŸç”Ÿè³ªå¹¾ä½•é«”"
    };

    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    let tick = 0;

    // --- é¡Œåº«é‚è¼¯ (S3 é‡é») ---
    function generateProblem() {
        state.wrongCount = 0;
        toggleInput(true);
        document.getElementById('answer-input').value = '';
        document.getElementById('answer-input').focus();

        const lvl = state.level;
        let q = {};
        
        // éš¨æ©Ÿæ•´æ•¸ç­”æ¡ˆ x (é¿å…åˆ†æ•¸ï¼Œé™ä½æŒ«æŠ˜æ„Ÿï¼Œå°ˆæ³¨å¹¾ä½•é‚è¼¯)
        const x = Math.floor(Math.random() * 6) + 3; // 3 to 8

        // é¡Œå‹æ± 
        const types = [];
        types.push('side_eq'); // å°é‚Šç›¸ç­‰ (Lv1+)
        if (lvl >= 2) types.push('angle_adj'); // åŒå´å…§è§’äº’è£œ (Lv2+)
        if (lvl >= 3) types.push('angle_opp'); // å°è§’ç›¸ç­‰ (Lv3+)
        if (lvl >= 4) types.push('diag_bisect'); // å°è§’ç·šå¹³åˆ† (Lv4+)

        const type = types[Math.floor(Math.random() * types.length)];

        if (type === 'side_eq') {
            // S3: å…©é‚Šéƒ½æœ‰ x çš„æ–¹ç¨‹å¼ (3x + 2 = x + 12)
            const a = Math.floor(Math.random() * 2) + 2; // 2 or 3
            const b = Math.floor(Math.random() * 5) + 1;
            // å³é‚Šå¼å­: x + d. 
            // ax + b = x + d  => (a-1)x + b = d
            const d = (a - 1) * x + b;
            
            q = {
                type: 'side',
                text: `åµæ¸¬åˆ°é‚Šé•·ç•°å¸¸ã€‚<br>åˆ©ç”¨ã€Œå°é‚Šç›¸ç­‰ã€æ€§è³ªæ±‚è§£ã€‚<br>${a}x + ${b} = x + ${d}`,
                hint: "å¹³è¡Œå››é‚Šå½¢çš„å°é‚Šé•·åº¦ç›¸ç­‰ (Top = Bottom)ã€‚",
                ans: x,
                draw: { top: `${a}x+${b}`, bottom: `x+${d}` }
            };

        } else if (type === 'angle_adj') {
            // S3: åŒå´å…§è§’äº’è£œ (A + B = 180)
            // (2x + 10) + (??) = 180
            const a = 2; 
            const b = Math.floor(Math.random() * 10) * 2; // å¶æ•¸
            const angleA = a * x + b;
            const angleB = 180 - angleA;
            
            // è®“ Angle B é¡¯ç¤ºç‚ºæ•¸å­—ï¼ŒAngle A é¡¯ç¤ºç‚ºå¼å­
            q = {
                type: 'angle_adj',
                text: `èƒ½é‡æµäº’æ–¥ï¼åŒå´å…§è§’ä¸ç©©ã€‚<br>è§’A (${a}x+${b}) èˆ‡ è§’B (${angleB}Â°) äº’è£œã€‚`,
                hint: "å¹³è¡Œå››é‚Šå½¢ä¸­ï¼Œé„°è§’ (Uå­—å‹/Cå­—å‹) ç›¸åŠ ç­‰æ–¼ 180 åº¦ã€‚",
                ans: x,
                draw: { A: `${a}x+${b}`, B: `${angleB}Â°` }
            };

        } else if (type === 'angle_opp') {
            // å°è§’ç›¸ç­‰ (3x - 10 = 50)
            const a = 3;
            const b = 10;
            const angleVal = a * x - b;
            q = {
                type: 'angle_opp',
                text: `æ ¸å¿ƒå…±æŒ¯ã€‚åˆ©ç”¨ã€Œå°è§’ç›¸ç­‰ã€æ±‚è§£ã€‚<br>${a}x - ${b} = ${angleVal}Â°`,
                hint: "å¹³è¡Œå››é‚Šå½¢çš„å°è§’ (Opposite Angles) æ•¸å€¼æ˜¯ç›¸ç­‰çš„ã€‚",
                ans: x,
                draw: { A: `${a}x-${b}`, C: `${angleVal}Â°` }
            };
        } else if (type === 'diag_bisect') {
             // å°è§’ç·šå¹³åˆ†
             const len = x + 5;
             q = {
                 type: 'diag',
                 text: `å°è§’ç·šäº¤é»åç§»ã€‚<br>ä¸€åŠé•·åº¦ç‚º ${len}ï¼Œå¦ä¸€åŠç‚º x+5`,
                 hint: "å¹³è¡Œå››é‚Šå½¢çš„å°è§’ç·šæœƒäº’ç›¸å¹³åˆ† (åˆ‡ä¸€åŠ)ã€‚",
                 ans: x,
                 draw: { d1: `${len}`, d2: `x+5` }
             };
        }

        state.question = q;
        uiMsg(q.text);
    }

    // --- ç¹ªåœ–ç³»çµ± ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        tick += 0.05;
        const floatY = Math.sin(tick) * 5;
        const cx = 185;
        const cy = 200 + floatY;
        
        // æ ¹æ“šå±¬æ€§æ”¹è®Šç¹ªåœ–é¢¨æ ¼
        // é€™è£¡ç°¡åŒ–è™•ç†ï¼Œé€é state.parts æ±ºå®š
        
        // 1. ç•«å…‰ç’°/ç¿…è†€ (èƒŒæ™¯å±¤)
        if (state.parts.wings === 'angel') drawWings(cx, cy, 'angel');
        if (state.parts.wings === 'demon') drawWings(cx, cy, 'demon');
        if (state.parts.aura === 'tech') drawAura(cx, cy, '#55ffff');
        if (state.parts.aura === 'fire') drawAura(cx, cy, '#ff5555');

        // 2. ç•«ä¸»é«” (å¹³è¡Œå››é‚Šå½¢)
        let skew = 40;
        // å¦‚æœç­”éŒ¯å¤šæ¬¡ï¼Œåœ–å½¢æœƒæ‰­æ›²
        if (state.wrongCount > 0 && !state.paused) skew = 10 + Math.sin(tick*10)*5;

        const w = 80; const h = 50;
        const p1 = {x:cx-w+skew, y:cy-h};
        const p2 = {x:cx+w+skew, y:cy-h};
        const p3 = {x:cx+w-skew, y:cy+h};
        const p4 = {x:cx-w-skew, y:cy+h};

        ctx.lineWidth = 3;
        ctx.lineJoin = 'round';
        ctx.strokeStyle = state.parts.color;
        ctx.fillStyle = hexToRgba(state.parts.color, 0.2);

        ctx.beginPath();
        ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
        ctx.lineTo(p3.x, p3.y); ctx.lineTo(p4.x, p4.y);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();

        // 3. ç•«è§’/æ ¸å¿ƒ (å‰æ™¯å±¤)
        if (state.parts.horns === 'sharp') drawHorns(cx, cy, 'sharp');
        if (state.parts.horns === 'bull') drawHorns(cx, cy, 'bull');
        if (state.parts.core === 'reactor') drawCore(cx, cy);

        // 4. ç•«é¡Œç›®æ¨™ç¤º (UI Overlay)
        drawQuestionOverlay(p1, p2, p3, p4);

        if (!state.paused) requestAnimationFrame(draw);
    }

    function drawQuestionOverlay(p1, p2, p3, p4) {
        if (!state.question) return;
        const q = state.question;
        ctx.fillStyle = '#fff';
        ctx.font = '10px "Press Start 2P"';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        if (q.type === 'side') {
            // é«˜äº®ä¸Šä¸‹é‚Š
            ctx.strokeStyle = '#ffff00'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(p3.x, p3.y); ctx.lineTo(p4.x, p4.y); ctx.stroke();
            
            ctx.fillText(q.draw.top, (p1.x+p2.x)/2, p1.y - 15);
            ctx.fillText(q.draw.bottom, (p3.x+p4.x)/2, p3.y + 15);
        } else if (q.type === 'angle_adj') {
            // ç•«é„°è§’ A(å·¦ä¸Š) B(å·¦ä¸‹)
            drawAngle(p1, 0, 1, q.draw.A, '#ff5555');
            drawAngle(p4, -1, 0, q.draw.B, '#5555ff');
            // ç•«å€‹ C å­—å‹é€£çµæç¤º
            ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.setLineDash([5,5]);
            ctx.beginPath(); ctx.moveTo(p1.x-10, p1.y+10); ctx.quadraticCurveTo(p1.x-30, (p1.y+p4.y)/2, p4.x-10, p4.y-10); ctx.stroke();
            ctx.setLineDash([]);
        } else if (q.type === 'angle_opp') {
            // ç•«å°è§’
            drawAngle(p1, 0, 1, q.draw.A, '#ff5555');
            drawAngle(p3, -1, 0, q.draw.C, '#ff5555');
        } else if (q.type === 'diag') {
            ctx.strokeStyle = '#aaa';
            ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p3.x, p3.y); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(p2.x, p2.y); ctx.lineTo(p4.x, p4.y); ctx.stroke();
            ctx.fillStyle = '#0f0';
            ctx.fillText(q.draw.d1, 185, 180);
            ctx.fillText(q.draw.d2, 185, 220);
        }
    }

    function drawAngle(p, startMult, endMult, text, color) {
        ctx.strokeStyle = color;
        ctx.beginPath(); ctx.arc(p.x, p.y, 25, 0, Math.PI*2); ctx.stroke(); // ç°¡åŒ–ç•«åœˆ
        ctx.fillStyle = color;
        // æ–‡å­—é¿è®“é‚è¼¯
        const offsetX = (p.x < 185) ? -40 : 40;
        ctx.fillText(text, p.x + offsetX, p.y);
    }

    // ç°¡å–®çš„å¹¾ä½•ç¹ªåœ–è¼”åŠ©
    function drawWings(x, y, type) {
        ctx.strokeStyle = (type==='angel') ? '#fff' : '#f00';
        ctx.lineWidth = 2;
        ctx.beginPath();
        // ç°¡å–®ç¤ºæ„
        ctx.moveTo(x, y); ctx.lineTo(x-80, y-50); ctx.lineTo(x-60, y+20); ctx.stroke();
        ctx.moveTo(x, y); ctx.lineTo(x+80, y-50); ctx.lineTo(x+60, y+20); ctx.stroke();
    }
    function drawHorns(x, y, type) {
        ctx.fillStyle = (type==='sharp') ? '#ff0000' : '#888';
        ctx.beginPath(); ctx.moveTo(x-20, y-40); ctx.lineTo(x-30, y-80); ctx.lineTo(x-10, y-50); ctx.fill();
        ctx.beginPath(); ctx.moveTo(x+20, y-40); ctx.lineTo(x+30, y-80); ctx.lineTo(x+10, y-50); ctx.fill();
    }
    function drawCore(x, y) {
        ctx.fillStyle = '#00ffff';
        ctx.beginPath(); ctx.arc(x, y, 10, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 10; ctx.shadowColor = '#00ffff'; ctx.stroke();
        ctx.shadowBlur = 0;
    }
    function drawAura(x, y, col) {
        ctx.strokeStyle = col;
        ctx.globalAlpha = 0.3;
        ctx.beginPath(); ctx.arc(x, y, 90 + Math.sin(tick)*10, 0, Math.PI*2); ctx.stroke();
        ctx.globalAlpha = 1.0;
    }

    // --- äº’å‹•èˆ‡é‚è¼¯ ---

    function checkAnswer() {
        const input = document.getElementById('answer-input');
        const val = parseInt(input.value);
        if (isNaN(val)) return;

        if (val === state.question.ans) {
            // Correct
            state.exp++;
            updateBar();
            uiMsg("åŒæ­¥ç‡ä¸Šå‡ï¼å¹¾ä½•çµæ§‹ç©©å®šã€‚");
            if (state.exp >= state.maxExp) {
                setTimeout(startEvolution, 1000);
            } else {
                setTimeout(generateProblem, 1500);
            }
        } else {
            // Wrong
            state.wrongCount++;
            handleWrong();
        }
    }

    function checkMC(idx) {
        // é¸æ“‡é¡Œé‚è¼¯... (æ­¤è™•ç°¡åŒ–ï¼Œå¯¦éš›æ‡‰é©—è­‰ç­”æ¡ˆ)
        // å‡è¨­ç¬¬ä¸€å€‹æŒ‰éˆ•ç¸½æ˜¯æ­£ç¢ºç­”æ¡ˆçš„ç°¡å–®æ¼”ç¤ºï¼Œæˆ–éœ€é…åˆ generateMC
        // é€™è£¡ç‚ºäº†æ¼”ç¤ºæµæš¢ï¼Œè‹¥æŒ‰ä¸‹é¸æ“‡é¡Œï¼Œé‡ç½®å•é¡Œ
        uiMsg("ç³»çµ±å¼·åˆ¶æ ¡æ­£ä¸­...");
        setTimeout(generateProblem, 1000);
    }

    function handleWrong() {
        const screen = document.getElementById('screen');
        screen.classList.remove('shake');
        void screen.offsetWidth; 
        screen.classList.add('shake');
        
        if (state.wrongCount >= 2) {
            uiMsg("éŒ¯èª¤éå¤šï¼å•Ÿå‹•ä¸‰é¸ä¸€è¼”åŠ©æ¨¡å¼ã€‚");
            toggleInput(false);
            // ç°¡å–®ç”Ÿæˆé¸é …
            const ans = state.question.ans;
            const opts = [ans, ans+2, ans-1].sort(()=>Math.random()-0.5);
            opts.forEach((v, i) => {
                document.getElementById('btn-'+i).innerText = v;
                document.getElementById('btn-'+i).onclick = function() {
                     if(v===ans) { state.exp++; updateBar(); uiMsg("æ ¡æ­£æˆåŠŸï¼"); setTimeout(generateProblem, 1500); }
                     else { alert("ç„¡æ•ˆæ•¸æ“šï¼"); }
                };
            });
        } else {
            uiMsg("è¨ˆç®—éŒ¯èª¤ï¼è«‹æª¢æŸ¥æ€§è³ª (Hint available).");
        }
    }

    // --- é€²åŒ–ç³»çµ± (æ ¸å¿ƒäº®é») ---
    
    const evoPool = {
        2: [ // Lv2 Choices
            { title:"èµ¤ç´…ä¹‹è§’", desc:"é•·å‡ºéŠ³åˆ©çš„è§’ã€‚<br>æ”»æ“Šå‹æ…‹ã€‚", style:'card-red', icon:'ğŸ˜ˆ', apply:()=>{state.parts.horns='sharp'; state.parts.color='#ffaaaa'; state.name="ç‹‚æš´ä¸‰è§’ç¸";} },
            { title:"é‹¼éµè£ç”²", desc:"å¢åŠ é˜²ç¦¦åšåº¦ã€‚<br>é˜²ç¦¦å‹æ…‹ã€‚", style:'card-blue', icon:'ğŸ›¡ï¸', apply:()=>{state.parts.horns='bull'; state.parts.color='#aaaaff'; state.name="é‡è£å››é‚Šç¸";} },
            { title:"å…‰å­æ ¸å¿ƒ", desc:"èƒ¸å£èšè®Šåæ‡‰ã€‚<br>èƒ½é‡å‹æ…‹ã€‚", style:'card-yellow', icon:'âš›ï¸', apply:()=>{state.parts.core='reactor'; state.parts.color='#ffffaa'; state.name="å…‰èƒ½æ ¸å¿ƒç¸";} }
        ],
        3: [ // Lv3 Choices
            { title:"æƒ¡é­”ä¹‹ç¿¼", desc:"ç²å¾—é£›è¡Œèƒ½åŠ›ã€‚<br>é€Ÿåº¦æå‡ã€‚", style:'card-red', icon:'ğŸ¦‡', apply:()=>{state.parts.wings='demon';} },
            { title:"å¤©ä½¿ä¹‹ç¾½", desc:"ç¥è–å¹¾ä½•åŠ è­·ã€‚<br>å¹¸é‹æå‡ã€‚", style:'card-blue', icon:'ğŸª½', apply:()=>{state.parts.wings='angel';} },
            { title:"è™›ç©ºå…‰ç’°", desc:"å¹²æ¶‰å‘¨åœç£å ´ã€‚<br>æ§åˆ¶æå‡ã€‚", style:'card-yellow', icon:'â­•', apply:()=>{state.parts.aura='tech';} }
        ]
    };

    function startEvolution() {
        state.paused = true;
        const choices = evoPool[state.level + 1] || evoPool[2]; // é è¨­ç”¨ Lv2 çš„åšæ¼”ç¤º
        
        const container = document.getElementById('cards-box');
        container.innerHTML = '';
        
        choices.forEach(c => {
            const card = document.createElement('div');
            card.className = `evo-card ${c.style}`;
            card.innerHTML = `
                <div class="card-title">${c.title}</div>
                <div class="card-icon">${c.icon}</div>
                <div class="card-desc">${c.desc}</div>
            `;
            card.onclick = () => {
                c.apply();
                endEvolution();
            };
            container.appendChild(card);
        });

        document.getElementById('evo-overlay').style.display = 'flex';
    }

    function endEvolution() {
        state.level++;
        state.exp = 0;
        state.maxExp += 2;
        updateBar();
        document.getElementById('lvl-num').innerText = state.level;
        document.getElementById('monster-name').innerText = state.name;
        document.getElementById('evo-overlay').style.display = 'none';
        state.paused = false;
        
        uiMsg(`é€²åŒ–å®Œæˆï¼<br>å€‹é«”åï¼š${state.name}`);
        draw(); // Force redraw
        setTimeout(generateProblem, 2000);
    }

    // --- Utils ---
    function updateBar() {
        const pct = (state.exp / state.maxExp) * 100;
        document.getElementById('exp-fill').style.width = pct + "%";
    }
    function uiMsg(txt) { document.getElementById('msg-box').innerHTML = txt; }
    function toggleInput(isInput) {
        document.getElementById('input-area').style.display = isInput ? 'flex' : 'none';
        document.getElementById('mc-area').style.display = isInput ? 'none' : 'flex';
    }
    function hexToRgba(hex, alpha) {
        // ç°¡å–®è½‰æ›ï¼Œå¯¦éš›å°ˆæ¡ˆå¯ç”¨æ›´åš´è¬¹çš„ regex
        return hex; // Canvas fillStyle support hex usually, just returning hex for now or adapt if needed
    }
    function useHint() {
        if(state.hints > 0 && state.question) {
            state.hints--;
            document.getElementById('hint-btn').innerText = `ğŸ’¡ æç¤º(${state.hints})`;
            alert(state.question.hint);
        }
    }

    // Start
    generateProblem();
    draw();

</script>
</body>
</html>
