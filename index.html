<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¾ä½•ç¸ç·¨å¹´å² v6.2 - ä½ç½®ä¿®æ­£ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212;
            --console: #2a2a2a;
            --screen: #1e3a29;
            --text-main: #aaffaa;
            --text-warn: #ff5555;
            --accent: #00e5ff;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Press Start 2P', cursive;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            user-select: none;
            overflow: hidden;
        }

        #device {
            background: linear-gradient(145deg, #333, #111);
            padding: 25px;
            border-radius: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8), inset 0 2px 5px rgba(255,255,255,0.1);
            border: 5px solid #000;
            width: 460px;
            position: relative;
        }

        #screen-container {
            background: #000;
            padding: 10px;
            border-radius: 15px;
            box-shadow: inset 0 0 20px #000;
        }

        #screen {
            background-color: var(--screen);
            width: 100%;
            height: 500px;
            position: relative;
            overflow: hidden;
            border: 2px solid #334433;
            image-rendering: pixelated;
        }

        /* æƒæç·š */
        #screen::after {
            content: ""; position: absolute; top:0; left:0; width:100%; height:100%;
            background: linear-gradient(rgba(0,0,0,0) 50%, rgba(0,0,0,0.1) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 99;
        }

        /* HUD */
        .hud {
            position: absolute; top: 15px; left: 15px; right: 15px;
            display: flex; justify-content: space-between;
            font-size: 12px;
            z-index: 10;
            text-shadow: 1px 1px 0 #000;
        }
        .stage-badge {
            background: var(--accent); color: #000; padding: 4px 8px; border-radius: 4px;
        }

        .progress-dots {
            display: flex; gap: 6px; margin-top: 6px; justify-content: flex-end;
        }
        .dot { width: 10px; height: 10px; background: #335544; border: 2px solid #557766; }
        .dot.active { background: #ffff00; box-shadow: 0 0 5px #ffff00; border-color: #ffff00; }
        .dot.done { background: #00ff00; border-color: #00ff00;}

        canvas { position: absolute; top: 0; left: 0; z-index: 1; }

        /* ä¸‹æ–¹æ§åˆ¶å° */
        #controls {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: 160px; /* é€™å€‹é«˜åº¦é®æ“‹äº†ä¹‹å‰çš„ç¹ªåœ– */
            background: rgba(0, 20, 0, 0.95);
            border-top: 4px solid var(--text-main);
            padding: 20px;
            box-sizing: border-box;
            z-index: 20;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        #msg { 
            font-size: 13px; 
            line-height: 1.7; 
            color: #fff; 
            height: 60px; 
            overflow-y: auto; 
        }

        .input-row { display: flex; justify-content: space-between; align-items: flex-end; }
        
        input {
            background: #000; border: 3px solid var(--text-main); color: var(--text-main);
            font-family: inherit; padding: 12px; width: 90px; text-align: center; 
            font-size: 16px;
        }
        
        button {
            background: #222; color: #fff; border: 3px solid #fff;
            padding: 12px 18px; font-family: inherit; 
            font-size: 12px; cursor: pointer;
            text-transform: uppercase; box-shadow: 3px 3px 0 #000;
        }
        button:active { transform: translate(2px, 2px); box-shadow: none; }

        /* è¦†è“‹å±¤ */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96);
            z-index: 50;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 30px; box-sizing: border-box;
        }

        .quiz-btn {
            background: #333; border: 3px solid #555; color: #fff;
            width: 100%; padding: 18px; margin: 12px 0; text-align: left;
            font-size: 12px; line-height: 1.5; cursor: pointer; transition: 0.2s;
        }
        .quiz-btn:hover { background: #444; border-color: var(--accent); }

        .cards-row { display: flex; gap: 15px; margin-top: 25px; }
        .evo-card {
            width: 110px; height: 160px; border: 3px solid #fff; padding: 12px;
            background: #222; cursor: pointer; display: flex; flex-direction: column;
            align-items: center; transition: 0.3s;
        }
        .evo-card:hover { transform: scale(1.05); box-shadow: 0 0 20px var(--accent); }
        .card-icon { font-size: 32px; margin: 15px 0; }
        .card-title { font-size: 10px; color: var(--accent); margin-bottom: 8px; }
        .card-desc { font-size: 8px; color: #aaa; line-height: 1.5; }

        .shake { animation: shake 0.4s; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-2px, 0); } 100% { transform: translate(0, 0); } }
    </style>
</head>
<body>

<div id="device">
    <div id="screen-container">
        <div id="screen">
            <div class="hud">
                <div>
                    <span class="stage-badge" id="stage-badge">é—œå¡ 1</span>
                    <div style="margin-top:8px; font-size:10px;" id="stage-name">é‚Šä¹‹ç…‰</div>
                </div>
                <div style="text-align:right;">
                    <div id="monster-name" style="font-size:12px;">å¹¾ä½•å¹¼é«”</div>
                    <div class="progress-dots" id="dots-container">
                        <div class="dot active"></div><div class="dot"></div><div class="dot"></div>
                    </div>
                </div>
            </div>

            <canvas id="canvas" width="440" height="500"></canvas>

            <div id="quiz-overlay" class="overlay">
                <h3 style="color:var(--accent); margin-bottom:25px; font-size:16px;">âš ï¸ å¹¾ä½•åŒæ­¥æ¸¬è©¦ âš ï¸</h3>
                <p id="quiz-q" style="font-size:13px; margin-bottom:25px; line-height:1.8;">é¡Œç›®è¼‰å…¥ä¸­...</p>
                <div id="quiz-options" style="width:100%"></div>
            </div>

            <div id="evo-overlay" class="overlay">
                <h3 style="color:#ffff00; font-size:18px;">ğŸ§¬ åŸºå› çªè®Š ğŸ§¬</h3>
                <p style="font-size:12px; margin-top:10px;">è©¦ç…‰é€šéï¼é¸æ“‡é€²åŒ–æ–¹å‘ï¼š</p>
                <div class="cards-row" id="evo-cards"></div>
            </div>

            <div id="controls">
                <div id="msg">ç³»çµ±é€£ç·šä¸­...</div>
                <div class="input-row" id="input-area">
                    <button onclick="hint()" style="border-color:#ffff00; color:#ffff00; font-size:12px;">ğŸ’¡ æç¤º</button>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:14px;">x=</span>
                        <input type="number" id="ans-input" placeholder="?">
                    </div>
                    <button onclick="submitAns()" style="background:#004400; border-color:#00ff00; font-size:14px;">æ³¨å…¥</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const game = {
        stage: 1,
        questionIndex: 0,
        totalPerStage: 3,
        currentQ: null,
        monster: { name: "å¹¾ä½•å¹¼é«”", color: "#aaffaa", bodyType: 'basic', headType: 'basic', wingType: 'none' },
        paused: false
    };

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let tick = 0;

    const stageInfo = {
        1: { name: "é‚Šä¹‹ç…‰", prop: "å°é‚Šç›¸ç­‰", color: "#00e5ff" },
        2: { name: "è§’ä¹‹ç…‰", prop: "å°è§’ç›¸ç­‰", color: "#ff5555" },
        3: { name: "è»¸ä¹‹ç…‰", prop: "å°è§’ç·šå¹³åˆ†", color: "#ffff00" }
    };

    function generateProblem() {
        game.paused = false;
        document.getElementById('ans-input').value = '';
        document.getElementById('ans-input').focus();
        updateDots();

        const x = Math.floor(Math.random() * 6) + 3;
        let q = {};

        if (game.stage === 1) {
            const a = Math.floor(Math.random()*2)+2;
            const b = Math.floor(Math.random()*5)+1;
            const d = (a-1)*x + b;
            q = {
                type: 'side', ans: x,
                text: `[è©¦ç…‰1-${game.questionIndex+1}] é‚Šé•·ç•°å¸¸ã€‚<br>ä¸Šé‚Š=${a}x+${b}, ä¸‹é‚Š=x+${d}`,
                hint: "å¹³è¡Œå››é‚Šå½¢ã€Œå°é‚Šé•·åº¦ç›¸ç­‰ã€ã€‚\nä¸Šé‚Š = ä¸‹é‚Šï¼Œåˆ—å‡ºç®—å¼è§£ xã€‚",
                draw: { top: `${a}x+${b}`, bottom: `x+${d}` }
            };
        } else if (game.stage === 2) {
            const a = Math.floor(Math.random()*2)+2; 
            const offset = 10;
            const val = a * x - offset;
            q = {
                type: 'angle', ans: x,
                text: `[è©¦ç…‰2-${game.questionIndex+1}] è§’åº¦æ ¡æº–ã€‚<br>è§’A=${a}x-${offset}, å°è§’C=${val}Â°`,
                hint: "å¹³è¡Œå››é‚Šå½¢ã€Œå°è§’ç›¸ç­‰ã€ã€‚\nè§’ A = è§’ Cã€‚",
                draw: { A: `${a}x-${offset}`, C: `${val}Â°` }
            };
        } else if (game.stage === 3) {
            const val = x + 5;
            q = {
                type: 'diag', ans: x,
                text: `[è©¦ç…‰3-${game.questionIndex+1}] è»¸ç·šåç§»ã€‚<br>åŠè»¸é•·=${val}, å¦ä¸€åŠ=2x+${5-x}`,
                hint: "å¹³è¡Œå››é‚Šå½¢ã€Œå°è§’ç·šäº’ç›¸å¹³åˆ†ã€ã€‚\nåˆ‡é–‹çš„å…©æ®µé•·åº¦ä¸€æ¨£ã€‚",
                draw: { d1: `${val}`, d2: `2x+${5-x}` }
            };
        }

        game.currentQ = q;
        uiMsg(q.text);
    }

    function triggerBossQuiz() {
        game.paused = true;
        const overlay = document.getElementById('quiz-overlay');
        const qText = document.getElementById('quiz-q');
        const optsDiv = document.getElementById('quiz-options');
        optsDiv.innerHTML = '';
        overlay.style.display = 'flex';

        let quizData = {};
        if (game.stage === 1) {
            quizData = {
                q: "ã€é‚Šä¹‹è©¦ç…‰ç¸½çµã€‘<br>é—œæ–¼å¹³è¡Œå››é‚Šå½¢çš„ã€Œé‚Šã€ï¼Œä¸‹åˆ—æ•˜è¿°ä½•è€…æ­£ç¢ºï¼Ÿ",
                opts: [ { txt: "é„°é‚Šé•·åº¦ä¸€å®šç›¸ç­‰ (AB=BC)", correct: false }, { txt: "å°é‚Šé•·åº¦ä¸€å®šç›¸ç­‰ (AB=CD)", correct: true }, { txt: "å››æ¢é‚Šé•·åº¦éƒ½å¿…é ˆä¸€æ¨£", correct: false } ]
            };
        } else if (game.stage === 2) {
            quizData = {
                q: "ã€è§’ä¹‹è©¦ç…‰ç¸½çµã€‘<br>é—œæ–¼å¹³è¡Œå››é‚Šå½¢çš„ã€Œè§’ã€ï¼Œä¸‹åˆ—æ•˜è¿°ä½•è€…æ­£ç¢ºï¼Ÿ",
                opts: [ { txt: "å°è§’ç›¸ç­‰ (âˆ A = âˆ C)", correct: true }, { txt: "å°è§’äº’è£œ (âˆ A + âˆ C = 180Â°)", correct: false }, { txt: "å››å€‹è§’éƒ½æ˜¯ 90Â°", correct: false } ]
            };
        } else {
            quizData = {
                q: "ã€è»¸ä¹‹è©¦ç…‰ç¸½çµã€‘<br>é—œæ–¼å¹³è¡Œå››é‚Šå½¢çš„ã€Œå°è§’ç·šã€ï¼Œä¸‹åˆ—æ•˜è¿°ä½•è€…æ­£ç¢ºï¼Ÿ",
                opts: [ { txt: "å°è§’ç·šé•·åº¦ä¸€å®šç›¸ç­‰", correct: false }, { txt: "å°è§’ç·šæœƒäº’ç›¸å‚ç›´", correct: false }, { txt: "å°è§’ç·šæœƒäº’ç›¸å¹³åˆ†", correct: true } ]
            };
        }

        qText.innerHTML = quizData.q;
        quizData.opts.sort(() => Math.random() - 0.5);

        quizData.opts.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'quiz-btn';
            btn.innerText = opt.txt;
            btn.onclick = () => {
                if (opt.correct) {
                    alert("è§€å¿µæ­£ç¢ºï¼åŸºå› é–è§£é–‹ï¼");
                    overlay.style.display = 'none';
                    triggerEvolution();
                } else {
                    alert("è§€å¿µéŒ¯èª¤ï¼å—åˆ°åå™¬å‚·å®³ï¼(è«‹å†è©¦ä¸€æ¬¡)");
                }
            };
            optsDiv.appendChild(btn);
        });
    }

    function triggerEvolution() {
        const overlay = document.getElementById('evo-overlay');
        const cardsDiv = document.getElementById('evo-cards');
        cardsDiv.innerHTML = '';
        overlay.style.display = 'flex';

        let choices = [];
        if (game.stage === 1) {
            choices = [
                { name: "ç†”å²©æ ¸å¿ƒ", icon: "ğŸ”¥", type: "magma", desc: "èº«é«”æµå‹•è‘—é«˜ç†±ç†”å²©ã€‚<br>æ”»æ“Šç‰¹åŒ–ã€‚" },
                { name: "éˆ¦é‡‘è£ç”²", icon: "âš™ï¸", type: "mech", desc: "å …ä¸å¯æ‘§çš„æ©Ÿæ¢°å¤–æ®¼ã€‚<br>é˜²ç¦¦ç‰¹åŒ–ã€‚" },
                { name: "è™›ç©ºæ°´æ™¶", icon: "ğŸ’", type: "crystal", desc: "ç¥ç§˜çš„å¹¾ä½•çµæ™¶é«”ã€‚<br>é­”åŠ›ç‰¹åŒ–ã€‚" }
            ];
        } else if (game.stage === 2) {
            choices = [
                { name: "å·¨é¾ä¹‹è§’", icon: "ğŸ‰", type: "dragon", desc: "é å¤ç”Ÿç‰©çš„å¨åš´ã€‚" },
                { name: "é›·é”é™£åˆ—", icon: "ğŸ“¡", type: "radar", desc: "ç²¾æº–é–å®šç›®æ¨™ã€‚" },
                { name: "ç¥è–å…‰ç’°", icon: "ğŸ˜‡", type: "holy", desc: "å¹¾ä½•ä¹‹ç¥çš„åŠ è­·ã€‚" }
            ];
        } else {
            choices = [
                { name: "æƒ¡é­”ä¹‹ç¿¼", icon: "ğŸ¦‡", type: "demon", desc: "æ’•è£‚ç©ºé–“çš„é›™ç¿¼ã€‚" },
                { name: "å™´å°„æ¨é€²", icon: "ğŸš€", type: "jet", desc: "è¶…éŸ³é€Ÿæ©Ÿå‹•æ€§ã€‚" },
                { name: "å…­ç¿¼å¤©ä½¿", icon: "âœ¨", type: "angel", desc: "è¶…è¶Šç¶­åº¦çš„å­˜åœ¨ã€‚" }
            ];
        }

        choices.forEach(c => {
            const card = document.createElement('div');
            card.className = 'evo-card';
            card.innerHTML = `
                <div class="card-title">${c.name}</div>
                <div class="card-icon">${c.icon}</div>
                <div class="card-desc">${c.desc}</div>
            `;
            card.onclick = () => {
                applyEvolution(c.type);
                overlay.style.display = 'none';
                nextStage();
            };
            cardsDiv.appendChild(card);
        });
    }

    function applyEvolution(type) {
        if (game.stage === 1) game.monster.bodyType = type;
        if (game.stage === 2) game.monster.headType = type;
        if (game.stage === 3) game.monster.wingType = type;
        
        const prefixes = { magma: "ç†”å²©", mech: "é‹¼éµ", crystal: "çµæ™¶", dragon: "é¾è§’", radar: "æ©Ÿå‹•", holy: "ç¥è–" };
        const suffix = { demon: "é­”ç‹", jet: "æˆ°æ©Ÿ", angel: "å¤©ä½¿" };
        
        let newName = "";
        if(game.stage === 1) newName = prefixes[type] + "å¹¾ä½•é«”";
        if(game.stage === 2) newName = prefixes[game.monster.headType] + prefixes[game.monster.bodyType] + "ç¸";
        if(game.stage === 3) newName = "ç©¶æ¥µ" + prefixes[game.monster.bodyType] + suffix[type];
        
        game.monster.name = newName;
        document.getElementById('monster-name').innerText = newName;
    }

    function nextStage() {
        if (game.stage < 3) {
            game.stage++;
            game.questionIndex = 0;
            const info = stageInfo[game.stage];
            document.getElementById('stage-badge').innerText = `é—œå¡ ${game.stage}`;
            document.getElementById('stage-badge').style.background = info.color;
            document.getElementById('stage-name').innerText = info.name;
            uiMsg(`é€²å…¥ä¸‹ä¸€å±¤ï¼š${info.name}ï¼`);
            setTimeout(generateProblem, 2000);
        } else {
            alert("æ­å–œï¼ä½ å·²å®Œå…¨æŒæ¡å¹³è¡Œå››é‚Šå½¢çš„æ‰€æœ‰å¥§ç¾©ï¼");
            uiMsg("å…¨é—œå¡åˆ¶éœ¸ï¼å¹¾ä½•å¤§å¸«èª•ç”Ÿã€‚");
        }
    }

    function submitAns() {
        const val = parseInt(document.getElementById('ans-input').value);
        if (isNaN(val)) return;
        if (val === game.currentQ.ans) {
            game.questionIndex++;
            uiMsg("è¨ˆç®—æ­£ç¢ºï¼èƒ½é‡æ³¨å…¥ã€‚");
            if (game.questionIndex >= game.totalPerStage) {
                setTimeout(triggerBossQuiz, 1000);
            } else {
                setTimeout(generateProblem, 1000);
            }
        } else {
            uiMsg("éŒ¯èª¤ï¼è«‹æª¢æŸ¥ç®—å¼ã€‚");
            const sc = document.getElementById('screen');
            sc.classList.remove('shake');
            void sc.offsetWidth; sc.classList.add('shake');
        }
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        tick += 0.05;
        const floatY = Math.sin(tick) * 6;
        
        // --- ä¿®æ­£æ ¸å¿ƒ ---
        // å°‡ä¸­å¿ƒé»å¾ 250 ä¸Šç§»åˆ° 210ï¼Œé¿å…è¢«ä¸‹æ–¹ 160px çš„æ§åˆ¶å€é®æ“‹
        // æ§åˆ¶å€é ‚éƒ¨ä½ç½®ç´„ç‚º y=340
        // æ€ªç¸åº•éƒ¨ä½ç½®ç´„ç‚º 210 + 70(h) = 280
        // æ–‡å­—ä½ç½®ç´„ç‚º 280 + 30 = 310 < 340 (å®‰å…¨)
        const cx = 220, cy = 210 + floatY; 

        drawWings(cx, cy);
        drawBody(cx, cy);
        drawHead(cx, cy);
        drawOverlay();
        requestAnimationFrame(draw);
    }

    function drawBody(cx, cy) {
        const type = game.monster.bodyType;
        let color = '#aaffaa';
        if (type === 'magma') color = '#ff5500';
        if (type === 'mech') color = '#aaaaff';
        if (type === 'crystal') color = '#ff00ff';

        ctx.fillStyle = color;
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 4;

        const w = 100, h = 70, skew = 35;
        const p1 = {x:cx-w+skew, y:cy-h};
        const p2 = {x:cx+w+skew, y:cy-h};
        const p3 = {x:cx+w-skew, y:cy+h};
        const p4 = {x:cx-w-skew, y:cy+h};
        game.coords = {p1, p2, p3, p4};

        ctx.beginPath();
        ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
        ctx.lineTo(p3.x, p3.y); ctx.lineTo(p4.x, p4.y);
        ctx.closePath();
        
        if (type === 'basic') {
            ctx.globalAlpha = 0.3; ctx.fill(); ctx.globalAlpha = 1; ctx.stroke();
        } else if (type === 'magma') {
            ctx.globalAlpha = 0.8; ctx.fill(); 
            ctx.strokeStyle = '#ffff00'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(cx, cy); ctx.lineTo(p3.x, p3.y); ctx.stroke();
        } else if (type === 'mech') {
            ctx.fillStyle = '#333'; ctx.fill(); ctx.stroke();
            ctx.fillStyle = '#0ff';
            ctx.fillRect(cx-15, cy-15, 30, 30);
            ctx.beginPath(); ctx.moveTo(cx-w, cy); ctx.lineTo(cx+w, cy); ctx.stroke();
        } else if (type === 'crystal') {
            ctx.fillStyle = 'rgba(255, 0, 255, 0.5)'; ctx.fill(); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(cx, cy-h); ctx.lineTo(cx+w/2, cy); ctx.lineTo(cx, cy+h); ctx.lineTo(cx-w/2, cy); ctx.closePath(); ctx.stroke();
        }
    }

    function drawHead(cx, cy) {
        const type = game.monster.headType;
        const yTop = cy - 70; 
        ctx.fillStyle = '#fff';
        if (type === 'dragon') {
            ctx.fillStyle = '#dddddd';
            ctx.beginPath(); ctx.moveTo(cx-35, yTop); ctx.lineTo(cx-70, yTop-70); ctx.lineTo(cx-25, yTop-25); ctx.fill();
            ctx.beginPath(); ctx.moveTo(cx+35, yTop); ctx.lineTo(cx+70, yTop-70); ctx.lineTo(cx+25, yTop-25); ctx.fill();
        } else if (type === 'radar') {
            ctx.strokeStyle = '#0f0'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(cx, yTop); ctx.lineTo(cx, yTop-60); ctx.stroke();
            if (Math.floor(tick*5)%2===0) { ctx.fillStyle='#f00'; ctx.beginPath(); ctx.arc(cx, yTop-60, 6, 0, Math.PI*2); ctx.fill(); }
        } else if (type === 'holy') {
            ctx.strokeStyle = '#ffcc00'; ctx.lineWidth=4;
            ctx.beginPath(); ctx.ellipse(cx, yTop-50, 50, 12, 0, 0, Math.PI*2); ctx.stroke();
        }
        ctx.fillStyle = '#000'; ctx.fillRect(cx-25, cy-12, 12, 12); ctx.fillRect(cx+13, cy-12, 12, 12);
        ctx.fillStyle = '#fff'; ctx.fillRect(cx-22, cy-10, 5, 5); ctx.fillRect(cx+16, cy-10, 5, 5);
    }

    function drawWings(cx, cy) {
        const type = game.monster.wingType;
        if (type === 'none') return;
        ctx.save(); ctx.translate(cx, cy);
        if (type === 'demon') {
            ctx.fillStyle = '#550000';
            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-140, -90); ctx.lineTo(-90, 30); ctx.fill();
            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(140, -90); ctx.lineTo(90, 30); ctx.fill();
        } else if (type === 'jet') {
            ctx.fillStyle = '#888'; ctx.fillRect(-110, -25, 50, 70); ctx.fillRect(60, -25, 50, 70);
            ctx.fillStyle = '#f00';
            ctx.beginPath(); ctx.moveTo(-85, 45); ctx.lineTo(-100, 90+Math.random()*25); ctx.lineTo(-70, 90+Math.random()*25); ctx.fill();
            ctx.beginPath(); ctx.moveTo(85, 45); ctx.lineTo(70, 90+Math.random()*25); ctx.lineTo(100, 90+Math.random()*25); ctx.fill();
        } else if (type === 'angel') {
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.beginPath(); ctx.ellipse(-90, -25, 70, 35, -0.5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(90, -25, 70, 35, 0.5, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();
    }

    function drawOverlay() {
        if (!game.currentQ || !game.coords) return;
        const q = game.currentQ;
        const {p1, p2, p3, p4} = game.coords;
        ctx.fillStyle = '#fff';
        ctx.font = '14px "Press Start 2P"';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';

        if (q.type === 'side') {
            ctx.strokeStyle = '#ff0'; ctx.lineWidth=4;
            ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(p3.x, p3.y); ctx.lineTo(p4.x, p4.y); ctx.stroke();
            ctx.fillText(q.draw.top, (p1.x+p2.x)/2, p1.y-25);
            ctx.fillText(q.draw.bottom, (p3.x+p4.x)/2, p3.y+35);
        } else if (q.type === 'angle') {
            ctx.strokeStyle = '#f00'; ctx.lineWidth=3;
            ctx.beginPath(); ctx.arc(p1.x, p1.y, 30, 0, Math.PI*2); ctx.stroke();
            ctx.beginPath(); ctx.arc(p3.x, p3.y, 30, 0, Math.PI*2); ctx.stroke();
            ctx.fillText(q.draw.A, p1.x-45, p1.y);
            ctx.fillText(q.draw.C, p3.x+45, p3.y);
        } else if (q.type === 'diag') {
            ctx.strokeStyle = 'rgba(255,255,255,0.6)'; ctx.lineWidth=2;
            ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p3.x, p3.y); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(p2.x, p2.y); ctx.lineTo(p4.x, p4.y); ctx.stroke();
            ctx.fillStyle = '#0f0';
            ctx.fillText(q.draw.d1, 220, 200); // å¾€ä¸Šå¾®èª¿
            ctx.fillText(q.draw.d2, 220, 290); // å¾€ä¸Šå¾®èª¿
        }
    }

    function updateDots() {
        const dots = document.querySelectorAll('.dot');
        dots.forEach((d, i) => {
            d.className = 'dot';
            if (i < game.questionIndex) d.classList.add('done');
            if (i === game.questionIndex) d.classList.add('active');
        });
    }

    function uiMsg(txt) { document.getElementById('msg').innerHTML = txt; }
    function hint() { if(game.currentQ) alert(game.currentQ.hint); }

    generateProblem();
    draw();
</script>
</body>
</html>
